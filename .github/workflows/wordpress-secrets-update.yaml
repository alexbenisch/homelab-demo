name: Update WordPress Secrets

on:
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of secret update'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - wordpress_admin
          - chatbot
          - mysql

env:
  SECRET_FILE: apps/base/wordpress/secret.yaml

jobs:
  update-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SOPS
        run: |
          wget https://github.com/getsops/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64
          sudo mv sops-v3.9.0.linux.amd64 /usr/local/bin/sops
          sudo chmod +x /usr/local/bin/sops
          sops --version

      - name: Install age
        run: |
          wget https://github.com/FiloSottile/age/releases/download/v1.2.0/age-v1.2.0-linux-amd64.tar.gz
          tar xzf age-v1.2.0-linux-amd64.tar.gz
          sudo mv age/age /usr/local/bin/
          sudo mv age/age-keygen /usr/local/bin/
          age --version

      - name: Setup SOPS age key
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          mkdir -p ~/.config/sops/age
          echo "$SOPS_AGE_KEY" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      - name: Decrypt current secret
        run: |
          sops -d ${{ env.SECRET_FILE }} > /tmp/secret-decrypted.yaml

      - name: Update secrets from GitHub Secrets
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          WP_ADMIN_USER: ${{ secrets.WP_ADMIN_USER }}
          WP_ADMIN_PASSWORD: ${{ secrets.WP_ADMIN_PASSWORD }}
          WP_ADMIN_EMAIL: ${{ secrets.WP_ADMIN_EMAIL }}
          CHATBOT_API_USER: ${{ secrets.CHATBOT_API_USER }}
          CHATBOT_API_PASSWORD: ${{ secrets.CHATBOT_API_PASSWORD }}
          CHATBOT_DEFAULT_LANGUAGE: ${{ secrets.CHATBOT_DEFAULT_LANGUAGE }}
        run: |
          cat > /tmp/secret-decrypted.yaml << 'EOF'
          apiVersion: v1
          kind: Secret
          metadata:
              name: wordpress-secret
          type: Opaque
          stringData:
              MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
              MYSQL_USER: ${MYSQL_USER}
              MYSQL_PASSWORD: ${MYSQL_PASSWORD}
              WP_ADMIN_USER: ${WP_ADMIN_USER}
              WP_ADMIN_PASSWORD: ${WP_ADMIN_PASSWORD}
              WP_ADMIN_EMAIL: ${WP_ADMIN_EMAIL}
              CHATBOT_API_USER: ${CHATBOT_API_USER}
              CHATBOT_API_PASSWORD: ${CHATBOT_API_PASSWORD}
              CHATBOT_DEFAULT_LANGUAGE: ${CHATBOT_DEFAULT_LANGUAGE}
          EOF

          # Substitute environment variables
          envsubst < /tmp/secret-decrypted.yaml > /tmp/secret-final.yaml

      - name: Re-encrypt secret with SOPS
        run: |
          sops -e /tmp/secret-final.yaml > ${{ env.SECRET_FILE }}

      - name: Add SOPS metadata
        run: |
          # Add the SOPS configuration if not present
          if ! grep -q "encrypted_regex" ${{ env.SECRET_FILE }}; then
            cat >> ${{ env.SECRET_FILE }} << 'EOF'
          sops:
              encrypted_regex: ^(data|stringData)$
          EOF
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet ${{ env.SECRET_FILE }}; then
            echo "No changes to commit"
          else
            git add ${{ env.SECRET_FILE }}
            git commit -m "Update WordPress secrets from GitHub Secrets

          Updated via automated workflow: ${{ github.workflow }}

          ðŸ¤– Generated with GitHub Actions"
            git push
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/secret-decrypted.yaml /tmp/secret-final.yaml
          rm -rf ~/.config/sops
