#cloud-config
# Cloud-init configuration for k3s worker node 1
# Upload this to Hetzner Cloud when creating the server
# IMPORTANT: Replace <CONTROL_PLANE_IP> and <K3S_TOKEN> before using!

# Set hostname
hostname: wrkr1

# Create users
users:
  - name: alex
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAmm9jDoXxpMFSGUYFUCk56TaPPTxMRdgnTY9FCBwjF3
    lock_passwd: false

# Set passwords
chpasswd:
  list: |
    root:123password
    alex:123password
  expire: True

# Package updates and installations
package_update: true
package_upgrade: true
packages:
  - curl
  - wget
  - git
  - vim
  - htop
  - net-tools

# Write k3s installation script
write_files:
  - path: /root/install-k3s-agent.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # CONFIGURATION - UPDATE THESE VALUES!
      K3S_URL="https://<CONTROL_PLANE_PRIVATE_IP>:6443"
      K3S_TOKEN="<K3S_TOKEN_FROM_CONTROL_PLANE>"

      echo "Installing k3s agent..."

      # Install k3s in agent mode
      curl -sfL https://get.k3s.io | K3S_URL="${K3S_URL}" K3S_TOKEN="${K3S_TOKEN}" sh -s - agent \
        --node-name wrkr1 \
        --node-ip $(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')

      echo "k3s agent installation complete!"
      echo "Run 'kubectl get nodes' on the control plane to verify"

# Run commands on first boot
runcmd:
  - echo "Cloud-init started for worker node 1"
  - timedatectl set-timezone UTC
  - systemctl enable systemd-timesyncd
  - systemctl start systemd-timesyncd
  - echo "Cloud-init completed for worker node 1"
  - echo "MANUAL STEP REQUIRED: Edit /root/install-k3s-agent.sh with control plane IP and token, then run it"

# Final message
final_message: |
  Cloud-init for wrkr1 has completed!

  NEXT STEPS:
  1. SSH into this server: ssh alex@<server-ip>
  2. Get the K3S_TOKEN from control plane: ssh control-plane 'sudo cat /root/k3s-token'
  3. Edit the installation script: sudo nano /root/install-k3s-agent.sh
     - Replace <CONTROL_PLANE_PRIVATE_IP> with the private IP (e.g., 10.0.1.10)
     - Replace <K3S_TOKEN_FROM_CONTROL_PLANE> with the actual token
  4. Run: sudo /root/install-k3s-agent.sh
  5. Verify on control plane: kubectl get nodes

  Password: 123password (change on first login!)
