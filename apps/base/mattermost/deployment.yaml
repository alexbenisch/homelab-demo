apiVersion: apps/v1
kind: Deployment
metadata:
  name: mattermost
  namespace: mattermost
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mattermost
  template:
    metadata:
      labels:
        app: mattermost
    spec:
      securityContext:
        fsGroup: 2000
        runAsUser: 2000
        runAsGroup: 2000
      containers:
        - name: mattermost
          image: mattermost/mattermost-team-edition:9.11
          ports:
            - containerPort: 8065
          env:
            - name: MM_SQLSETTINGS_DRIVERNAME
              value: "postgres"
            - name: MM_SQLSETTINGS_DATASOURCE
              valueFrom:
                secretKeyRef:
                  name: mattermost-secret
                  key: MM_SQLSETTINGS_DATASOURCE
            - name: MM_SERVICESETTINGS_SITEURL
              value: "https://mattermost.kubetest.uk"
            - name: MM_SERVICESETTINGS_ENABLELOCALMODE
              value: "false"
            - name: MM_PLUGINSETTINGS_ENABLEUPLOADS
              value: "true"
          volumeMounts:
            - name: mattermost-data
              mountPath: /mattermost/data
            - name: mattermost-data
              mountPath: /mattermost/logs
              subPath: logs
            - name: mattermost-data
              mountPath: /mattermost/config
              subPath: config
            - name: mattermost-data
              mountPath: /mattermost/plugins
              subPath: plugins
            - name: mattermost-data
              mountPath: /mattermost/client/plugins
              subPath: client-plugins
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 2Gi
          livenessProbe:
            httpGet:
              path: /api/v4/system/ping
              port: 8065
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/v4/system/ping
              port: 8065
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
      volumes:
        - name: mattermost-data
          persistentVolumeClaim:
            claimName: mattermost-data-pvc
