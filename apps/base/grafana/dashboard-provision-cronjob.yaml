apiVersion: batch/v1
kind: CronJob
metadata:
  name: grafana-dashboard-provision
  namespace: grafana
spec:
  schedule: "*/10 * * * *"  # Every 10 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: grafana-dashboard-provision
        spec:
          serviceAccountName: grafana-config
          restartPolicy: OnFailure
          containers:
            - name: provision-dashboard
              image: nixery.dev/shell/jq/curl
              command: ["/bin/sh", "/scripts/provision-dashboards.sh"]
              env:
                - name: GRAFANA_URL
                  value: "http://grafana.grafana.svc.cluster.local:3000"
                - name: GRAFANA_USER
                  value: "admin"
                - name: GRAFANA_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: grafana-credentials
                      key: admin-password
              volumeMounts:
                - name: provision-scripts
                  mountPath: /scripts
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
              securityContext:
                allowPrivilegeEscalation: false
          volumes:
            - name: provision-scripts
              configMap:
                name: grafana-dashboard-provision-script
                defaultMode: 0755
