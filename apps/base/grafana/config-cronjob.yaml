apiVersion: batch/v1
kind: CronJob
metadata:
  name: grafana-datasource-sync
  namespace: grafana
spec:
  schedule: "0 * * * *"  # Every hour
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: grafana-config
        spec:
          serviceAccountName: grafana-config
          restartPolicy: OnFailure
          containers:
            - name: configure
              image: nixery.dev/shell/jq/curl
              command: ["/bin/sh", "/scripts/configure-datasources.sh"]
              env:
                - name: GRAFANA_URL
                  value: "http://grafana.grafana.svc.cluster.local:3000"
                - name: GRAFANA_USER
                  value: "admin"
                - name: GRAFANA_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: grafana-credentials
                      key: admin-password
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
                  readOnly: true
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
              securityContext:
                allowPrivilegeEscalation: false
          volumes:
            - name: scripts
              configMap:
                name: grafana-config-script
                defaultMode: 0755
