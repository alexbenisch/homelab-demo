apiVersion: batch/v1
kind: CronJob
metadata:
  name: grafana-dashboard-init
  namespace: grafana
spec:
  schedule: "*/10 * * * *"  # Every 10 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: grafana-dashboard-init
        spec:
          serviceAccountName: grafana-config
          restartPolicy: OnFailure
          containers:
            - name: init-dashboard
              image: nixery.dev/shell/jq/curl
              command: ["/bin/sh", "-c"]
              args:
                - |
                  #!/bin/sh
                  set -e

                  GRAFANA_URL="http://grafana.grafana.svc.cluster.local:3000"
                  DASHBOARD_UID="kubernetes-cluster-overview"

                  echo "Initializing dashboard queries..."

                  # Trigger dashboard snapshot which forces query execution
                  curl -s -u "$GRAFANA_USER:$GRAFANA_PASSWORD" \
                    "$GRAFANA_URL/api/dashboards/uid/$DASHBOARD_UID" > /dev/null

                  echo "âœ“ Dashboard initialized"
              env:
                - name: GRAFANA_USER
                  value: "admin"
                - name: GRAFANA_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: grafana-credentials
                      key: admin-password
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
              securityContext:
                allowPrivilegeEscalation: false
